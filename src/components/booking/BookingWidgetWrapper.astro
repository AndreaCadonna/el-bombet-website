---
// BookingWrapper.astro
import BookingWidget from './BookingWidgetPerProperty';

interface Props {
  property: string;
}

const { property } = Astro.props;

// Define environment variables explicitly
const ENV = {
  X_API_KEY: import.meta.env.X_API_KEY,
  PROPERTY_IDS: {
    SMALL: import.meta.env.SMALL_ID,
    MEDIUM: import.meta.env.MEDIUM_ID,
    LARGE: import.meta.env.LARGE_ID,
  },
} as const;

// Validate environment variables at build time
if (!ENV.X_API_KEY) {
  throw new Error('X_API_KEY environment variable is not defined');
}

// Add max guests mapping
const getMaxGuests = (propertySize: string): number => {
  switch (propertySize.toLowerCase()) {
    case 'small':
      return 2;
    case 'medium':
      return 4;
    case 'large':
      return 8;
    default:
      return 4;
  }
};

const maxGuests = getMaxGuests(property);

let availability: { room_type_id: string; property_id: string }[] | null = null;
let minStayRules: { calendar_items: { date: string; prices: { min_stay: number }[] }[] } | null = null;
let error: string | null = null;

const getPropertyId = (propertyKey: string): string => {
  const envKey = propertyKey.toUpperCase() as keyof typeof ENV.PROPERTY_IDS;
  const propertyId = ENV.PROPERTY_IDS[envKey];

  if (!propertyId) {
    throw new Error(`Property ID not found for ${propertyKey}. Please check your environment variables.`);
  }

  return propertyId;
};

const now = new Date();
const sixMonthsFromNow = new Date();
sixMonthsFromNow.setMonth(now.getMonth() + 6);

const startDate = now.toISOString();
const endDate = sixMonthsFromNow.toISOString();

try {
  const propertyId = getPropertyId(property);

  // First fetch availability to get room_type_id
  const availabilityResponse = await fetch(
    `https://api.lodgify.com/v2/availability/${propertyId}?start=${startDate}&end=${endDate}`,
    {
      headers: {
        Authorization: `Bearer ${ENV.X_API_KEY}`,
        'Content-Type': 'application/json',
        'X-ApiKey': ENV.X_API_KEY,
      },
    }
  );

  if (!availabilityResponse.ok) {
    throw new Error('Failed to fetch availability');
  }

  availability = await availabilityResponse.json();

  // Extract room_type_id from availability response
  if (availability?.[0]?.room_type_id) {
    const roomTypeId = availability[0].room_type_id;
    const houseId = availability[0].property_id;

    // Then fetch rates using the room_type_id and house_id
    const ratesResponse = await fetch(
      `https://api.lodgify.com/v2/rates/calendar?roomTypeId=${roomTypeId}&houseId=${houseId}&startDate=${startDate}&endDate=${endDate}`,
      {
        headers: {
          Authorization: `Bearer ${ENV.X_API_KEY}`,
          'Content-Type': 'application/json',
          'X-ApiKey': ENV.X_API_KEY,
        },
      }
    );

    if (!ratesResponse.ok) {
      throw new Error('Failed to fetch rates');
    }

    minStayRules = await ratesResponse.json();
  }
} catch (e) {
  error = e instanceof Error ? e.message : 'An unknown error occurred';
}
---

<div>
  {error && <p class="text-red-500">{error}</p>}
  <BookingWidget client:idle availability={availability} minStayRules={minStayRules} maxGuests={maxGuests} />
</div>
